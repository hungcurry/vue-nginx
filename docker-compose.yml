# region ç’°å¢ƒèªæ³•
# -----------------------------------
# ~ä½¿ç”¨ docker-compose å•Ÿå‹•æ‰€æœ‰ç’°å¢ƒ
# docker-compose up -d
# docker-compose up --build -d

# ~æŸ¥çœ‹é‹è¡Œä¸­çš„æœå‹™
# docker-compose ps
# docker-compose logs -f prod

#~ åœæ­¢æ‰€æœ‰å®¹å™¨/ åˆªé™¤æ‰€æœ‰æ˜ åƒ/ åˆªé™¤æ‰€æœ‰å·
# docker-compose down --rmi all --volumes

# -----------------------------------
# ğŸ”¥æ²’æœ‰ ä½¿ç”¨ Docker ç’°å¢ƒè®Šæ•¸æ™‚
# ç›´æ¥ä½¿ç”¨ /etc/nginx/conf.d/default.conf ä½œç‚º Nginx é…ç½®æª”æ¡ˆã€‚
# é€™æ˜¯ Nginx ç›´æ¥è®€å–ä¸¦é‹è¡Œçš„è¨­å®šæª”ï¼Œä¸ç”¨é¡å¤–è™•ç†ã€‚

# ğŸ”¥æœ‰  ä½¿ç”¨ Docker ç’°å¢ƒè®Šæ•¸æ™‚
# ä½¿ç”¨ /etc/nginx/templates/default.conf.template ä½œç‚º æ¨¡æ¿æª”æ¡ˆã€‚
# Docker é€²å…¥é»è…³æœ¬ æœƒå°‡ç’°å¢ƒè®Šæ•¸å¡«å…¥é€™å€‹æ¨¡æ¿ï¼Œ
# ç„¶å¾Œç”¢ç”Ÿ /etc/nginx/conf.d/default.conf

# ğŸ”¥æŸ¥çœ‹å®¹å™¨ç›®éŒ„å…§å®¹
# ls -1 æŒ‡ä»¤
# ls -l /etc/nginx/conf.d

# ğŸ”¥è®€å–æª”æ¡ˆ
# cat æŒ‡ä»¤
# cat /usr/share/nginx/html/dev

# ğŸ”¥å„ç’°å¢ƒéœæ…‹æ–‡ä»¶çš„ç›®éŒ„
# docker exec -it vue-dev sh
# ls -l /usr/share/nginx/html
# ls -l /usr/share/nginx/html/dev
# cat /usr/share/nginx/html/dev/index.html

# ğŸ”¥é€²å…¥å®¹å™¨ vue-dev
# docker exec -it vue-dev sh
# ls -l /etc/nginx
# cat /etc/nginx/templates/default.conf.template
# cat /etc/nginx/conf.d/default.conf

# ğŸ”¥é€²å…¥å®¹å™¨ nginx-proxy
# docker exec -it nginx-proxy sh
# ls -l /etc/nginx
# cat /etc/nginx/conf.d/default.conf

# å¤–éƒ¨
# nginx:
# ports: - '8080:90'
# // 8080 æ˜¯å¤–éƒ¨é€£çµ 90 æ˜¯å…§éƒ¨å®¹å™¨
# æ‰€ä»¥ç¶²å€æ˜¯ http://localhost:8080/
# 90 å°æ‡‰åˆ° nginx çš„å®¹å™¨ listen 90;

# å…§éƒ¨(å®¹å™¨)
# server {
#   listen 90;
#   server_name localhost;
# }

# æˆ‘æœ¬åœ° 3 å€‹ç’°å¢ƒ dockerfile ç”¢ç”Ÿçš„ç¶²å€
# http://localhost:4040/dev/
# http://localhost:4041/test/
# http://localhost:4042/prod/

# éƒ½æŠŠå‰é¢ç¶²å€è½‰æˆ http://localhost:8080
# åŒä¸€å€‹ç¶²å€å–ä»£
# http://localhost:8080/dev/
# http://localhost:8080/test/
# http://localhost:8080/prod/
#endregion

version: '3.8'
# åœ¨æ–‡ä»¶é–‹é ­å®šç¾©ç¶²çµ¡
networks:
  app-network:
    driver: bridge

volumes:
  vue-dev-source:
  vue-test-source:
  vue-prod-source:

services:
  dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    ports:
      - '4040:80'
    container_name: vue-dev
    image: vue-docker-dev
    restart: unless-stopped
    volumes:
      - vue-dev-source:/app
      - /app/node_modules
    networks:
      - app-network

  test:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    ports:
      - '4041:80' # ä½¿ç”¨ä¸åŒçš„ç«¯å£
    container_name: vue-test
    image: vue-docker-test
    restart: unless-stopped
    volumes:
      - vue-test-source:/app
      - /app/node_modules
    networks:
      - app-network

  prod:
    build:
      context: .
      dockerfile: docker/Dockerfile.prod
    ports:
      - '4042:80' # ä½¿ç”¨ä¸åŒçš„ç«¯å£
    container_name: vue-prod
    image: vue-docker-prod
    restart: unless-stopped
    volumes:
      - vue-prod-source:/app
      - /app/node_modules
    networks:
      - app-network

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - '8080:90'
    container_name: nginx-proxy
    depends_on:
      - dev
      - test
      - prod
    volumes:
      - ./nginx/nginx-share.conf:/etc/nginx/conf.d/default.conf
    networks:
      - app-network
    restart: unless-stopped
